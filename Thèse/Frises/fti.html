<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning Recherche Action Participative</title>

  <!-- Timeline KnightLab -->
  <link rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css" />
  <script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>

  <style>
    body { background:#fff; color:#111; font-family:system-ui,sans-serif; margin:0; padding:0; }

    /* --- INLINE --- */
    #note-inline[hidden]{display:none;}
    #note-inline{margin-top:1rem;}
    .note-inline-card{background:#0b0f19;color:#e5e7eb;border:1px solid #1f2937;border-radius:12px;
      padding:1rem 1.25rem;line-height:1.6;}
    .note-inline-close{float:right;background:transparent;border:none;color:#e5e7eb;font-size:1.5rem;cursor:pointer;}
    .note-inline-body a{color:#DAA520;text-decoration:underline;}

    /* --- DRAWER --- */
    #note-drawer[hidden]{display:none;}
    #note-drawer{position:fixed;top:0;right:0;height:100vh;width:0;overflow:hidden;background:#0b0f19;
      color:#e5e7eb;border-left:1px solid #1f2937;transition:width .35s ease;z-index:9999;}
    #note-drawer.open{width:min(720px,80vw);}
    .note-drawer-close{position:absolute;top:.5rem;right:.5rem;background:transparent;border:none;
      color:#e5e7eb;font-size:1.5rem;cursor:pointer;}
    .note-drawer-body{padding:1.25rem 1.5rem;line-height:1.6;}
    .note-drawer-body a{color:#DAA520;text-decoration:underline;}

    /* --- MODAL (thème clair “bibliothèque”) --- */
    #note-modal[hidden]{display:none;}
    #note-modal{position:fixed;inset:0;z-index:9999;}
    .note-modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,.35);}
    .note-modal-card{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(780px,92vw);max-height:80vh;overflow:auto;
      background:#fffef8;color:#1b1b1b;border:1px solid #d9cbb3;border-radius:12px;
      box-shadow:0 12px 28px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.06);
    }
    .note-modal-close{position:absolute;top:.5rem;right:.5rem;background:transparent;border:none;color:#6b5630;font-size:1.5rem;cursor:pointer;}
    .note-modal-close:hover,.note-modal-close:focus{outline:none;color:#3f321a;text-shadow:0 0 1px rgba(0,0,0,.15);}
    .note-modal-body{padding:1.25rem 1.5rem;line-height:1.65;}
    .note-modal-body a{color:#8a6b19;text-decoration:underline;}
    .note-modal-body a:hover,.note-modal-body a:focus{color:#5e4c12;outline:none;}
    .note-modal-body h2, .note-modal-body h3{color:#2a2a2a;}
    .note-modal-body blockquote{margin:0 0 1rem 0;padding:.75rem 1rem;border-left:4px solid #d9cbb3;background:#fff9ee;border-radius:8px;}

    /* --- HIGHLIGHT BLOCS --- */
    .highlight{border-left:4px solid goldenrod;background-color:cornsilk;color:dimgray;padding:1rem 1.25rem;border-radius:10px;font-style:italic;margin:1.2rem 0;}
    .highlight strong{color:darkgoldenrod;font-weight:600;}

    /* Libellés de groupe sur l’axe */
    .tl-timegroup-message{opacity:1 !important;color:#111 !important;font-weight:600;}
  </style>
</head>
<body>

  <!-- Frise -->
  <div id="timeline-embed" style="width:100%;height:600px"></div>

  <!-- Conteneurs des trois modes -->
  <div id="note-inline" hidden>
    <article class="note-inline-card">
      <button class="note-inline-close" aria-label="Fermer">×</button>
      <div class="note-inline-body"></div>
    </article>
  </div>

  <div id="note-drawer" hidden>
    <button class="note-drawer-close" aria-label="Fermer">×</button>
    <div class="note-drawer-body"></div>
  </div>

  <div id="note-modal" hidden>
    <div class="note-modal-overlay"></div>
    <div class="note-modal-card">
      <button class="note-modal-close" aria-label="Fermer">×</button>
      <div class="note-modal-body"></div>
    </div>
  </div>

  <script>
    // ---- MODE NOTE À TESTER ----
    const NOTE_MODE = "modal"; // "inline" | "drawer" | "modal"

    // ---------- Robustesse URL locales ----------
    const isFileProtocol = location.protocol === "file:";
    function showLoading(msg = "Chargement…") {
      const el = document.getElementById("timeline-embed");
      el.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:1rem;color:#555">${msg}</div>`;
    }
    function showError(msg) {
      const el = document.getElementById("timeline-embed");
      el.innerHTML = `<div style="padding:1rem">${msg}</div>`;
    }

    // ---------- Injection d'IDs stables ----------
    function addUniqueIds(data){
      if(!data || !Array.isArray(data.events)) return data;
      const seen = new Set();
      const slug = (s="") => s.toLowerCase().normalize("NFKD")
        .replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/^-+|-+$/g,"") || "evt";

      const makeId = (ev) => {
        if (ev.unique_id) return ev.unique_id;
        const g = slug(ev.group || "event");
        const sd = ev.start_date || {};
        const hasDate = Number.isInteger(sd.year) && Number.isInteger(sd.month) && Number.isInteger(sd.day);
        let base = hasDate
          ? `${String(sd.year).padStart(4,"0")}${String(sd.month).padStart(2,"0")}${String(sd.day).padStart(2,"0")}`
          : "undated";
        if (Number.isInteger(sd.hour) && Number.isInteger(sd.minute)){
          base += `${String(sd.hour).padStart(2,"0")}${String(sd.minute).padStart(2,"0")}`;
        }
        let uid = `${g}-${base}`;
        if (uid === "event-undated"){
          const head = (ev.text && ev.text.headline) || "event";
          uid = `${slug(head)}-${Date.now()}`;
        }
        const baseUid = uid; let n = 2;
        while (seen.has(uid)) uid = `${baseUid}-${n++}`;
        seen.add(uid);
        return uid;
      };

      data.events.forEach(ev => ev.unique_id = makeId(ev));
      return data;
    }

    // ---------- Instanciation Timeline ----------
    function mountTimeline(data) {
      new TL.Timeline("timeline-embed", data, {
        language: "fr",
        initial_zoom: 2,
        hash_bookmark: true,        // permaliens par slide
        timenav_height_percentage: 35, // confort navigation (adapter 30–45)
        marker_height_min: 30,         // densité marqueurs
        marker_padding: 6
      });
    }

    // ---------- Chargement JSON ----------
    showLoading();
    if (isFileProtocol) {
      showError(`Ouverture locale détectée (<code>file://</code>). <br>Pour charger <code>ftidata.json</code>, lance un petit serveur local.<br>
        Exemple : <code>python -m http.server</code> puis ouvre <code>http://localhost:8000/</code>`);
    } else {
      fetch("./ftidata.json", { cache: "no-store" })
        .then(r => r.ok ? r.json() : Promise.reject(new Error(`HTTP ${r.status}`)))
        .then(json => mountTimeline(addUniqueIds(json))) // ← injection des IDs
        .catch(err => showError(`Impossible de charger <code>ftidata.json</code> (${err.message}).`));
    }

    // ---------- Surcouche notes externes ----------
    (function(){
      const $ = sel => document.querySelector(sel);
      const openFile = id => fetch(`notes/${id}.html`, { cache:'no-store' })
        .then(r => r.ok ? r.text() : Promise.reject(new Error(`HTTP ${r.status}`)));

      const inline = {
        wrap: $('#note-inline'),
        body: $('#note-inline .note-inline-body'),
        closeBtn: $('#note-inline .note-inline-close'),
        open(html){ this.body.innerHTML = html; this.wrap.hidden = false; this.wrap.scrollIntoView({behavior:'smooth'}); },
        close(){ this.wrap.hidden = true; this.body.innerHTML=''; },
        bind(){ this.closeBtn.addEventListener('click', () => this.close()); }
      };

      const drawer = {
        wrap: $('#note-drawer'),
        body: $('#note-drawer .note-drawer-body'),
        closeBtn: $('#note-drawer .note-drawer-close'),
        open(html){ this.body.innerHTML = html; this.wrap.hidden = false; requestAnimationFrame(() => this.wrap.classList.add('open')); },
        close(){ this.wrap.classList.remove('open'); setTimeout(() => { this.wrap.hidden = true; this.body.innerHTML=''; }, 350); },
        bind(){
          this.closeBtn.addEventListener('click', () => this.close());
          document.addEventListener('keydown', e => { if(e.key === 'Escape' && !this.wrap.hidden) this.close(); });
        }
      };

      const modal = {
        wrap: $('#note-modal'),
        body: $('#note-modal .note-modal-body'),
        closeBtn: $('#note-modal .note-modal-close'),
        overlay: $('#note-modal .note-modal-overlay'),
        open(html){ this.body.innerHTML = html; this.wrap.hidden = false; },
        close(){ this.wrap.hidden = true; this.body.innerHTML=''; },
        bind(){
          this.closeBtn.addEventListener('click', () => this.close());
          this.overlay.addEventListener('click', () => this.close());
          document.addEventListener('keydown', e => { if(e.key === 'Escape' && !this.wrap.hidden) this.close(); });
        }
      };

      const modes = { inline, drawer, modal };
      modes[NOTE_MODE].bind();

      document.addEventListener('click', e => {
        const link = e.target.closest('a[data-note-id]');
        if(!link) return;
        e.preventDefault();
        const id = link.getAttribute('data-note-id');
        modes[NOTE_MODE].open('<p>Chargement…</p>');
        openFile(id)
          .then(html => modes[NOTE_MODE].open(html))
          .catch(err => modes[NOTE_MODE].open(`<p>Contenu introuvable : <code>notes/${id}.html</code> (${err.message}).</p>`));
      });
    })();
  </script>

</body>
</html>
